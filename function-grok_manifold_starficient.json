[
  {
    "id": "grok_manifold_starficient",
    "user_id": "824efa03-385c-4d1a-bdf3-46c8c19ecb15",
    "name": "Grok Manifold^",
    "type": "pipe",
    "content": "\"\"\"\ntitle: Grok Manifold^\nauthor: kha1n3vol3\nauthor_url: https://github.com/kha1n3vol3/grok-manifold\nfunding_url: https://www.starficient.com\nversion: 0.2\n\"\"\"\n\n\"\"\"\nModule: grok_pipe\nDescription: This module implements a Pipe class for interacting with the Grok API.\nIt provides functionality to fetch available models, process input messages (text and images),\nand handle both streaming and non-streaming API responses. The module uses Pydantic for\nconfiguration management and the requests library for HTTP communication.\n\nUsage:\n    Initialize the Pipe class and use its methods to interact with the Grok API:\n    >>> pipe = Pipe()\n    >>> models = pipe.pipes()\n    >>> response = pipe.pipe({\"model\": \"grok-beta\", \"messages\": [{\"role\": \"user\", \"content\": \"Hello\"}]})\n    Note: If GROK_API_KEY is not set, API requests may fail depending on server requirements.\n\"\"\"\n\n\"\"\"\nModule: grok_pipe\nDescription: This module implements a Pipe class for interacting with the Grok API.\nIt provides functionality to fetch available models, process input messages (text and images),\nand handle both streaming and non-streaming API responses. The module uses Pydantic for\nconfiguration management and the requests library for HTTP communication.\n\nUsage:\n    Initialize the Pipe class and use its methods to interact with the Grok API:\n    >>> pipe = Pipe()\n    >>> models = pipe.pipes()\n    >>> response = pipe.pipe({\"model\": \"grok-beta\", \"messages\": [{\"role\": \"user\", \"content\": \"Hello\"}]})\n    Note: If GROK_API_KEY is not set, API requests may fail depending on server requirements.\n\"\"\"\n\n\"\"\"\n           ████████           \n          ████████            \n         ████████             \n        ████████     █        \n       ████████     ███       \n      ████████     █████      \n     ████████     ███████     \n    ████████      ████████    \n   ████████        ████████   \n  ████████          ████████  \n ████████            ████████ \n████████              ████████\n\"\"\"\n\nimport os\nimport json\nimport requests\nfrom typing import List, Union, Generator, Iterator, Optional, Dict\nfrom pydantic import BaseModel, Field\nfrom open_webui.utils.misc import (\n    pop_system_message,\n)  # Updated import path as per your example\n\n\nclass Pipe:\n    \"\"\"\n    A class to manage interactions with the Grok API, including model retrieval and message processing.\n\n    Attributes:\n        valves (Pipe.Valves): Configuration settings for API interactions.\n        type (str): Type identifier for the pipe.\n        id (str): Unique identifier for the pipe instance.\n        name (str): Name prefix for the pipe.\n    \"\"\"\n\n    class Valves(BaseModel):\n        \"\"\"\n        Configuration model for Grok API interactions using Pydantic.\n\n        Attributes:\n            GROK_API_KEY (str): API key for authentication with Grok services (optional).\n            GROK_API_BASE_URL (str): Base URL for Grok API endpoints.\n            MAX_TOKENS (int): Maximum number of tokens to generate in responses.\n            TEMPERATURE (float): Sampling temperature for response generation.\n            TOP_P (float): Nucleus sampling top_p value.\n            STREAM (bool): Flag to enable streaming responses.\n        \"\"\"\n\n        GROK_API_KEY: str = Field(default=\"\", description=\"API key for Grok services.\")\n        GROK_API_BASE_URL: str = Field(\n            default=\"https://api.x.ai/v1\",\n            description=\"Base URL for Grok API endpoints.\",\n        )\n        MAX_TOKENS: int = Field(\n            default=4096, description=\"Maximum number of tokens to generate.\"\n        )\n        TEMPERATURE: float = Field(default=0.8, description=\"Sampling temperature.\")\n        TOP_P: float = Field(default=0.9, description=\"Nucleus sampling top_p value.\")\n        STREAM: bool = Field(default=False, description=\"Whether to stream responses.\")\n\n    def __init__(self) -> None:\n        \"\"\"\n        Initialize the Pipe instance with configuration from environment variables.\n        \"\"\"\n        self.valves = self.Valves(\n            GROK_API_KEY=os.getenv(\"GROK_API_KEY\", \"\"),\n            GROK_API_BASE_URL=os.getenv(\"GROK_API_BASE_URL\", \"https://api.x.ai/v1\"),\n        )\n        self.type = \"manifold\"\n        self.id = \"grok\"\n        self.name = \"grok/\"\n        self.session = requests.Session()  # Reusable session for HTTP requests\n\n    def get_model_id(self, model_name: str) -> str:\n        \"\"\"\n        Extract the base model name from a potentially formatted string.\n\n        Args:\n            model_name (str): The model name, possibly including prefixes or separators.\n\n        Returns:\n            str: The base model name (e.g., \"grok-beta\" from \"prefix/grok-beta\").\n\n        Example:\n            >>> pipe = Pipe()\n            >>> pipe.get_model_id(\"xai.grok-beta\")\n            'grok-beta'\n        \"\"\"\n        parts = model_name.replace(\".\", \"/\").split(\"/\")\n        return parts[-1] if parts else \"\"\n\n    def get_grok_models(self) -> List[Dict[str, str]]:\n        \"\"\"\n        Fetch available models from the Grok API.\n\n        Returns:\n            List[Dict[str, str]]: A list of dictionaries containing model IDs and names,\n                                 empty if the request fails.\n\n        Example:\n            >>> pipe = Pipe()\n            >>> models = pipe.get_grok_models()\n            >>> print(models)\n            [{'id': 'grok-beta', 'name': 'grok-beta'}, ...]\n        \"\"\"\n        headers = {\n            \"Authorization\": f\"Bearer {self.valves.GROK_API_KEY}\",\n            \"Content-Type\": \"application/json\",\n        }\n        try:\n            response = self.session.get(\n                f\"{self.valves.GROK_API_BASE_URL}/models\", headers=headers, timeout=10\n            )\n            response.raise_for_status()\n            models_data = response.json()\n            return [\n                {\"id\": model[\"id\"], \"name\": model[\"id\"]}\n                for model in models_data.get(\"data\", [])\n            ]\n        except requests.RequestException as e:\n            print(f\"Error fetching models: {e}\")\n            return []\n\n    def pipes(self) -> List[Dict[str, str]]:\n        \"\"\"\n        Retrieve the list of available Grok models.\n\n        Returns:\n            List[Dict[str, str]]: A list of model information dictionaries.\n        \"\"\"\n        return self.get_grok_models()\n\n    def process_image(\n        self, image_data: Dict[str, Dict[str, str]]\n    ) -> Dict[str, Union[str, Dict]]:\n        \"\"\"\n        Process image data into a format suitable for the Grok API.\n\n        Args:\n            image_data (Dict[str, Dict[str, str]]): Image data containing a URL or base64 string.\n\n        Returns:\n            Dict[str, Union[str, Dict]]: Processed image data in API-compatible format,\n                                        empty dict if processing fails.\n\n        Example:\n            >>> pipe = Pipe()\n            >>> image = {\"image_url\": {\"url\": \"data:image/png;base64,abc123\"}}\n            >>> pipe.process_image(image)\n            {'type': 'image', 'source': {'type': 'base64', 'media_type': 'image/png', 'data': 'abc123'}}\n        \"\"\"\n        try:\n            url = image_data.get(\"image_url\", {}).get(\"url\", \"\")\n            if not url:\n                return {}\n            if url.startswith(\"data:image\"):\n                mime_type, base64_data = url.split(\",\", 1)\n                media_type = mime_type.split(\":\")[1].split(\";\")[0]\n                return {\n                    \"type\": \"image\",\n                    \"source\": {\n                        \"type\": \"base64\",\n                        \"media_type\": media_type,\n                        \"data\": base64_data,\n                    },\n                }\n            return {\n                \"type\": \"image\",\n                \"source\": {\"type\": \"url\", \"url\": url},\n            }\n        except (ValueError, IndexError):\n            return {}\n\n    def pipe(self, body: Dict) -> Union[str, Generator, Iterator]:\n        \"\"\"\n        Process input messages and interact with the Grok API.\n\n        Args:\n            body (Dict): Request body containing model, messages, and optional parameters.\n\n        Returns:\n            Union[str, Generator, Iterator]: Response content (string for non-streaming,\n                                            generator/iterator for streaming), or error message.\n\n        Example:\n            >>> pipe = Pipe()\n            >>> body = {\"model\": \"grok-beta\", \"messages\": [{\"role\": \"user\", \"content\": \"Hi\"}]}\n            >>> response = pipe.pipe(body)\n            'Hello there!'\n        \"\"\"\n        system_message, messages = pop_system_message(body.get(\"messages\", []))\n        processed_messages: List[Dict[str, str]] = []\n\n        for message in messages:\n            if not isinstance(message, dict) or \"role\" not in message:\n                continue\n            if isinstance(message.get(\"content\"), list):\n                for item in message[\"content\"]:\n                    if item.get(\"type\") == \"text\" and item.get(\"text\"):\n                        processed_messages.append(\n                            {\"role\": message[\"role\"], \"content\": item[\"text\"]}\n                        )\n                    elif item.get(\"type\") == \"image_url\":\n                        processed_image = self.process_image(item)\n                        if processed_image:\n                            processed_messages.append(processed_image)\n            elif message.get(\"content\"):\n                processed_messages.append(\n                    {\"role\": message[\"role\"], \"content\": str(message[\"content\"])}\n                )\n\n        if system_message:\n            processed_messages.insert(\n                0, {\"role\": \"system\", \"content\": str(system_message)}\n            )\n\n        model_id = self.get_model_id(body.get(\"model\", \"\"))\n        payload = {\n            \"model\": model_id,\n            \"messages\": processed_messages,\n            \"stream\": body.get(\"stream\", self.valves.STREAM),\n            \"temperature\": body.get(\"temperature\", self.valves.TEMPERATURE),\n            \"max_tokens\": body.get(\"max_tokens\", self.valves.MAX_TOKENS),\n            \"top_p\": body.get(\"top_p\", self.valves.TOP_P),\n            \"frequency_penalty\": body.get(\"frequency_penalty\", 0),\n            \"presence_penalty\": body.get(\"presence_penalty\", 0),\n            \"stop\": body.get(\"stop\", []),\n            \"user\": body.get(\"user\", \"\"),\n            \"n\": body.get(\"n\", 1),\n            \"logprobs\": body.get(\"logprobs\", False),\n            \"top_logprobs\": body.get(\"top_logprobs\", 0),\n        }\n\n        headers = {\n            \"Authorization\": f\"Bearer {self.valves.GROK_API_KEY}\",\n            \"Content-Type\": \"application/json\",\n        }\n        url = f\"{self.valves.GROK_API_BASE_URL}/chat/completions\"\n\n        try:\n            if payload[\"stream\"]:\n                return self.stream_response(url, headers, payload)\n            return self.non_stream_response(url, headers, payload)\n        except requests.RequestException as e:\n            print(f\"Error in pipe method: {e}\")\n            return f\"Error: {e}\"\n\n    def stream_response(\n        self, url: str, headers: Dict[str, str], payload: Dict\n    ) -> Generator[str, None, None]:\n        \"\"\"\n        Handle streaming responses from the Grok API.\n\n        Args:\n            url (str): API endpoint URL.\n            headers (Dict[str, str]): HTTP headers for the request.\n            payload (Dict): Request payload.\n\n        Yields:\n            str: Incremental content from the streaming response.\n\n        Example:\n            >>> pipe = Pipe()\n            >>> body = {\"model\": \"grok-beta\", \"messages\": [{\"role\": \"user\", \"content\": \"Hi\"}], \"stream\": True}\n            >>> for chunk in pipe.pipe(body):\n            ...     print(chunk, end='')\n            Hello there!\n        \"\"\"\n        with self.session.post(\n            url, headers=headers, json=payload, stream=True, timeout=30\n        ) as response:\n            if response.status_code != 200:\n                raise Exception(f\"HTTP Error {response.status_code}: {response.text}\")\n            for line in response.iter_lines():\n                if line:\n                    line_str = line.decode(\"utf-8\")\n                    if line_str.startswith(\"data: \"):\n                        try:\n                            data = json.loads(line_str[6:])\n                            if data.get(\"choices\") and \"delta\" in data[\"choices\"][0]:\n                                content = data[\"choices\"][0][\"delta\"].get(\"content\", \"\")\n                                if content:\n                                    yield content\n                        except json.JSONDecodeError as e:\n                            print(f\"Failed to parse JSON: {e}\")\n                            continue\n\n    def non_stream_response(\n        self, url: str, headers: Dict[str, str], payload: Dict\n    ) -> str:\n        \"\"\"\n        Handle non-streaming responses from the Grok API.\n\n        Args:\n            url (str): API endpoint URL.\n            headers (Dict[str, str]): HTTP headers for the request.\n            payload (Dict): Request payload.\n\n        Returns:\n            str: The complete response content, or an error message if the request fails.\n        \"\"\"\n        response = self.session.post(url, headers=headers, json=payload, timeout=30)\n        if response.status_code != 200:\n            raise Exception(f\"HTTP Error {response.status_code}: {response.text}\")\n        res = response.json()\n        return res[\"choices\"][0][\"message\"][\"content\"] if res.get(\"choices\") else \"\"\n\n\nif __name__ == \"__main__\":\n    # Example usage\n    pipe = Pipe()\n    body = {\"model\": \"grok-beta\", \"messages\": [{\"role\": \"user\", \"content\": \"Hello\"}]}\n    response = pipe.pipe(body)\n    print(response)\n",
    "meta": {
      "description": "api to grol",
      "manifest": {
        "title": "Grok Manifold^",
        "author": "kha1n3vol3",
        "author_url": "https://github.com/kha1n3vol3/grok-manifold",
        "funding_url": "https://www.starficient.com",
        "version": "0.2"
      }
    },
    "is_active": true,
    "is_global": false,
    "updated_at": 1740246917,
    "created_at": 1740243428
  }
]